# üó∫Ô∏è strapi-sea

![GitHub license](https://img.shields.io/github/license/swerder/strapi-sea)
![GitHub release](https://img.shields.io/github/v/release/swerder/strapi-sea)
![GitHub last commit](https://img.shields.io/github/last-commit/swerder/strapi-sea)
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg?style=flat-square)](http://makeapullrequest.com)
![GitHub contributors](https://img.shields.io/github/contributors/swerder/strapi-sea)
![GitHub pull requests](https://img.shields.io/github/issues-pr/swerder/strapi-sea)
![GitHub issues](https://img.shields.io/github/issues/swerder/strapi-sea)
![GitHub forks](https://img.shields.io/github/forks/swerder/strapi-sea)
![GitHub stars](https://img.shields.io/github/stars/swerder/strapi-sea)
![GitHub watchers](https://img.shields.io/github/watchers/swerder/strapi-sea)
![GitHub repo size](https://img.shields.io/github/repo-size/swerder/strapi-sea)
![GitHub code size](https://img.shields.io/github/languages/code-size/swerder/strapi-sea)
![GitHub language count](https://img.shields.io/github/languages/count/swerder/strapi-sea)
![GitHub top language](https://img.shields.io/github/languages/top/swerder/strapi-sea)

## ‚ÑπÔ∏è About
This project contains needed configs, scripts and patches for node modules to allow run [Strapi](https://github.com/strapi/strapi/) as a node.js [Single Executable Application](https://nodejs.org/docs/latest-v22.x/api/single-executable-applications.html) (SEA).

The Strapi app was generated by
```bash
npx create-strapi-app@5.14.0
```
and choose "sqlite" db.


## üöÄ Getting Started

### üõ†Ô∏è Prerequisites

- üì¶ Node.js 20.x
- üîß npm 10.x

#### üìã Installation Steps

#### 1. Prepare your project
**Attention:** you should first commit / stash all you changed files so you can verify the SEA specific changes after apply them.

The easiest way to prepare your project to use SEA is to apply the corresponding `strapi-sea-v<strapi version>.patch` to your workspace by download it from the [Release](https://github.com/swerder/strapi-sea/releases) page and call `git apply strapi-sea-vX.X.X.patch`:
```bash
strapiVersion=$(npm list @strapi/strapi --depth=0 | grep @strapi/strapi | awk '{print $2}' | sed 's/@strapi\/strapi@//')
patchName="strapi-sea-v${strapiVersion}.patch"
wget "https://github.com/zskarte/zskarte/archive/refs/tags/${patchName}"
git apply "${patchName}"
```

Install the new added packages
```bash
npm install
```

<details>
<summary>Alternative do it manually</summary>

Copy the files `patches/*, scripts/*, bundle_files/*, src/utils/*, src/server.ts` and the new scripts/configs in package.json to your project.

Install the needed packages
```bash
npm install --save better-sqlite3@11.8.1
npm install --save-dev node-loader null-loader tsx webpack webpack-cli
```
</details>

#### 2. Configure the logic
In the `package.json` you can define the configs:
- `executableName`: the name that the executable and zip will have.

If you want to use a different db system then sqlite for the SEA application you have to comment the corresponding lines in `bundle_files/webpack.config.js`, adjust `bundle_files/.env.exec.example` with the needed informations and install all required npm modules.


#### 3. Create your Strapi application
Do what you want with the Strapi project to fulfill your application goal (if not done already), and verify all work as expected on normal `npm run start`.

#### 4. Prepare minimal DB seeds
Adjust `bundle_files/seed-config.json` to add the minimal required db entries and relations for your application to work.

#### 5. Build the SEA executable for your application
**Attention:** the `bundled` and `exec` folders are always deleted on new build so make sure you update `seed-config.json` in `bundle_files` directory to keep it.
```bash
npm run build:all
```

#### 6. Test SEA executable for your application
```bash
npm run setup:sea
npm run start:sea
```
<details>
<summary>If you use windows</summary>
The start scripts in the package.json only work for unix based systems.
For Windows do:

```cmd
cd exec
startServer.cmd --setup
startServer.cmd
```
</details>

#### 7. Release your application
- Update your manual created `CHANGELOG.md` if any.
- Update the package release version:
    ```bash
    newVersion=<version>
    npm version ${newVersion} --no-git-tag-version
    git add package.json package-lock.json CHANGELOG.md
    git commit -m "Prepare release version ${newVersion}"
    git push
    ```
- Merge application to your main branch in cli or by pull request.
    <details>
    <summary>For do it in cli</summary>

    ```bash
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    git checkout main
    git merge $current_branch
    git push
    ```
    </details>

- Create release tag `v<version>` and push it.
    ```bash
    newVersion=<version>
    git tag v${newVersion}
    git push origin v${newVersion}
    ```

- The github action start to build all executables and create a draft release for it.

### Debugging Webpack

For debugging what files are found by my adjustments for webpack you can set some environment Variables:
```bash
export DEBUG_PRINT_WEBPACK_CONTEXT=1
export DEBUG_PRINT_CONFIG=1
export DEBUG_PRINT_STRAPI_MODULE=1
npm run start:sea
```

## ü§ù Contributing

We welcome contributions! Here's how you can help:
- üêõ Report bugs
- üîß Submit pull requests
- üìö Improve documentation

## üìù License

This project is licensed under the MIT License - see the LICENSE file for details.

## üêõ Known issues

For unused node_modules that pop up as missing errors in webpack build, I add them as "externals" in webpack config.

In the most cases I fix webpack warnings by implement a specific logic to load the required files.

In "umzug" I prevent to pack the cli part and disable the "glob" logic to define migration files.

In "knex" I disable the dynamic loading AbstractMigrationsLoader.getFile() and FsSeeds.getSeed() functions.

In "@strapi/core" and "@strapi/admin" I prevent "@strapi/typescript-utils" from being loaded and mock the functions.

The webpack build may still show different warnings in your codebase because off dynamic loading of modules.
Webpack load all libraries that are referenced in the code, also if they are not realy used.
If the warnings lead to problems on your side you can address them similar to the way I do it on the strapi modules (see patches).
Or prevent them to be loaded at all(see patches e.g umzug/knex).
